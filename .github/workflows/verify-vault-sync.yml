name: üïµÔ∏è Verify Vault Sync (Audit)

on:
  push:
    branches: [ "main", "feature/*" ]
  workflow_dispatch:

jobs:
  audit-configuration:
    name: üõ°Ô∏è Audit Variables & Secrets
    runs-on: ubuntu-latest
    
    # Permissions ajust√©es pour GITHUB_TOKEN
    permissions:
      contents: read
      actions: read  # C'est la cl√© magique pour lire la config des Actions

    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # √âTAPE 1 : Lister les VARIABLES (Doit fonctionner avec actions: read)
      # ------------------------------------------------------------------------
      - name: üìã List Repository Variables
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "::group::üìÇ All Available Variables"
          gh variable list || echo "‚ö†Ô∏è Cannot list variables (Permission Restriction)"
          echo "::endgroup::"

      # ------------------------------------------------------------------------
      # √âTAPE 2 : Audit des SECRETS (Documentaire uniquement)
      # ------------------------------------------------------------------------
      - name: üîê Audit Secret Configuration
        run: |
          echo "::group::üóùÔ∏è Secret Inventory Strategy"
          echo "‚ÑπÔ∏è SECURITY NOTE: The GITHUB_TOKEN is architecturally forbidden"
          echo "   from listing secret names via CLI to prevent reconnaissance."
          echo ""
          echo "üëâ We will validate Vault Sync by checking secret presence directly"
          echo "   in the 'Deep Dive' step below."
          echo "::endgroup::"

      # ------------------------------------------------------------------------
      # √âTAPE 3 : Preuve de Fonctionnement (V√©rification Specifique)
      # ------------------------------------------------------------------------
      - name: ‚úÖ Verify Vault Injection
        env:
          # On mappe les secrets Vault attendus
          DB_PASS: ${{ secrets.VAULT_DEMO_DB_PASSWORD }}
          API_KEY: ${{ secrets.VAULT_DEMO_API_KEY }}
        run: |
          echo "::group::üîç Deep Dive Verification"
          
          echo "Testing specific secrets injected by Terraform/Vault..."
          echo "---------------------------------------------------"

          # Test 1 : DB PASSWORD
          if [ -n "$DB_PASS" ]; then
            echo "‚úÖ VAULT_DEMO_DB_PASSWORD is Present (Length: ${#DB_PASS} chars)"
          else
            echo "‚ùå VAULT_DEMO_DB_PASSWORD is MISSING or EMPTY!"
            exit 1
          fi

          # Test 2 : API KEY
          if [ -n "$API_KEY" ]; then
            echo "‚úÖ VAULT_DEMO_API_KEY is Present (Length: ${#API_KEY} chars)"
          else
            echo "‚ùå VAULT_DEMO_API_KEY is MISSING or EMPTY!"
            exit 1
          fi
          
          echo "---------------------------------------------------"
          echo "üéâ SUCCESS: Vault secrets are correctly synchronized!"
          echo "::endgroup::"