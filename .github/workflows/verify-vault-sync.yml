name: üïµÔ∏è Verify Vault Sync (Advanced Showcase)

on:
  push:
    branches: [ "main", "feature/*" ]
  workflow_dispatch:

jobs:
  audit-configuration:
    name: üõ°Ô∏è Audit Vault Sync
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      # ========================================================================
      # STEP 1: AUDIT VARIABLES (Visible Configuration)
      # ========================================================================
      - name: üîì 1. Configuration & Metadata (Variables)
        run: |
          echo "::group::üìÇ Global Variables Context"
          echo "Dumping all available variables (non-sensitive data):"
          echo '${{ toJSON(vars) }}'
          echo "::endgroup::"

      - name: üíé 2. Advanced Feature Showcase (Transit & TOTP)
        env:
          CIPHER: ${{ vars.VAULT_TRANSIT_CIPHERTEXT }}
          MFA_URL: ${{ vars.MFA_SETUP_BARCODE }}
        run: |
          echo "::group::üîç Deep Dive: Advanced Features"
          
          echo "------------------------------------------------------------"
          echo "üîê ENCRYPTION AS A SERVICE (Transit Engine)"
          echo "------------------------------------------------------------"
          echo "Input Phrase: 'L'architecture SecOps Soltania est valid√©e !'"
          echo "Vault Output (Ciphertext):"
          echo "$CIPHER"
          echo ""
          echo "-> This value is encrypted. Even if exposed, it is safe without Vault access."
          
          echo "------------------------------------------------------------"
          echo "‚è±Ô∏è IDENTITY & MFA (TOTP Engine)"
          echo "------------------------------------------------------------"
          echo "Admin MFA Setup String:"
          echo "$MFA_URL"
          echo ""
          echo "-> Copy/Paste this URL into a browser to see the QR Code for Google Authenticator."
          echo "------------------------------------------------------------"
          
          echo "::endgroup::"

      # ========================================================================
      # STEP 2: AUDIT SECRETS (Masked Values)
      # ========================================================================
      - name: üîê 3. Secrets Inventory (Masked Values)
        run: |
          echo "::group::üóùÔ∏è Global Secrets Context"
          echo "Dumping all available secret keys."
          echo "‚ö†Ô∏è VALUES ARE MASKED (***) BY GITHUB SECURITY."
          echo "   Presence of keys proves successful synchronization from Vault."
          
          echo '${{ toJSON(secrets) }}'
          
          echo "::endgroup::"

      # ========================================================================
      # STEP 3: PKI VALIDATION (SSL Certificates)
      # ========================================================================
      - name: üìú 4. PKI & SSL Validation
        env:
          SSL_CERT: ${{ secrets.SSL_CERTIFICATE_PEM }}
          SSL_KEY: ${{ secrets.SSL_PRIVATE_KEY_PEM }}
        run: |
          echo "::group::üõ°Ô∏è PKI Health Check"
          
          echo "Checking SSL Certificate format..."
          if [[ "$SSL_CERT" == "-----BEGIN CERTIFICATE-----"* ]]; then
             echo "‚úÖ SSL_CERTIFICATE_PEM appears valid (Starts with PEM header)."
          else
             echo "‚ùå SSL_CERTIFICATE_PEM is invalid or missing!"
             exit 1
          fi

          echo "Checking Private Key presence..."
          if [[ "$SSL_KEY" == "-----BEGIN RSA PRIVATE KEY-----"* ]]; then
             echo "‚úÖ SSL_PRIVATE_KEY_PEM appears valid (Starts with PEM header)."
          else
             echo "‚ùå SSL_PRIVATE_KEY_PEM is invalid or missing!"
             exit 1
          fi
          
          echo "üéâ SUCCESS: Vault PKI has successfully issued certificates to GitHub!"
          echo "::endgroup::"