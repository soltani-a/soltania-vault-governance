# ğŸ” Soltania SecOps: Vault Configuration as Code

[![Vault](https://img.shields.io/badge/HashiCorp-Vault-gray?logo=vault&style=flat-square)](https://www.vaultproject.io/)
[![Terraform](https://img.shields.io/badge/Terraform-Managed-purple?logo=terraform&style=flat-square)](https://www.terraform.io/)
[![GitHub Actions](https://img.shields.io/badge/Integration-GitHub_Actions-2088FF?logo=github-actions&style=flat-square)]()
[![PKI](https://img.shields.io/badge/Security-PKI_Factory-green?style=flat-square)]()

**Centralized Identity, PKI & Secret Management Governance.**

This repository serves as the **Control Plane** for a HashiCorp Vault instance hosted on a private Edge Infrastructure (Synology NAS). It enforces **Least Privilege Principles** and **Secret Zero** methodology by managing policies, authentication methods, and dynamic secrets exclusively via Infrastructure as Code (IaC).

---

## ğŸ›ï¸ Architecture: The Hybrid Bridge

This project acts as a secure bridge between **On-Premise Infrastructure** and **Cloud CI/CD**. It generates secrets locally and securely injects them into GitHub.

```mermaid
flowchart TD
    subgraph "Local Control Plane"
        TF[ğŸ—ï¸ Terraform]
        Random[ğŸ² Random Provider]
    end

    subgraph "Edge Infrastructure (Synology)"
        Vault[ğŸ” HashiCorp Vault]
        KV[ğŸ“¦ KVv2 Secrets]
        Transit[ğŸ›¡ï¸ Transit (EaaS)]
        PKI[ğŸ“œ Internal CA]
        TOTP[â±ï¸ MFA/Identity]
    end

    subgraph "Cloud Ecosystem (GitHub)"
        GH_Secret[ğŸ”‘ Repository Secrets]
        GH_Var[ğŸ“„ Repository Variables]
        Pipeline[ğŸš€ CI/CD Pipelines]
    end

    TF -->|Provision & Configure| Vault
    Random -->|Generate Password| TF
    TF -->|Store Source of Truth| KV
    
    TF -->|Encrypt Payload| Transit
    TF -->|Issue Certs| PKI
    TF -->|Generate MFA Key| TOTP
    
    TF ==>|Inject Sensitive Data| GH_Secret
    TF ==>|Inject Config/Public Data| GH_Var
    
    GH_Secret & GH_Var -.->|Consumed by| Pipeline
````

-----

## ğŸ’ Features & Capabilities

This repository is not just about storage; it turns Vault into a **Security Factory**.

### 1\. ğŸ“¦ Dynamic Application Secrets (KVv2)

  * **Concept:** "Secret Zero". Passwords are generated by Terraform, stored in Vault, and synced to GitHub.
  * **Result:** No human knows the production passwords.
  * **Sync Target:** `secrets.VAULT_DB_PASSWORD`, `secrets.VAULT_API_KEY`.

### 2\. ğŸ” Encryption as a Service (Transit Engine)

  * **Concept:** Using Vault to encrypt data without storing it. Segregation of duties between the data owner and the encryption key owner.
  * **Result:** A ciphertext string is generated and stored as a **Variable**. It can only be decrypted by an authenticated AppRole.
  * **Sync Target:** `vars.VAULT_TRANSIT_CIPHERTEXT`.

### 3\. ğŸ“œ Internal PKI (Certificate Authority)

  * **Concept:** Vault acts as an Internal Root CA. It issues valid SSL certificates (PEM, Key, CA Bundle) for internal domains (`*.internal.soltania.local`).
  * **Result:** Automated SSL lifecycle management.
  * **Sync Target:** `secrets.SSL_CERTIFICATE_PEM`, `secrets.SSL_PRIVATE_KEY_PEM`.

### 4\. â±ï¸ Identity & MFA (TOTP Engine)

  * **Concept:** Management of Time-based One-Time Password keys for administrators.
  * **Result:** Terraform generates the Setup Barcode URL for Google Authenticator.
  * **Sync Target:** `vars.MFA_SETUP_BARCODE`.

-----

## ğŸ•µï¸ Automated Validation Workflow

To demonstrate the successful configuration without exposing sensitive data, a specialized GitHub Actions workflow runs on every push.

**Workflow File:** `.github/workflows/verify-vault-sync.yml`

```mermaid
sequenceDiagram
    participant GitHub as â˜ï¸ GitHub Platform
    participant Workflow as ğŸ•µï¸ Audit Workflow
    participant Context as ğŸ“¦ Runner Context
    
    GitHub->>Workflow: Trigger (Push/Dispatch)
    
    rect rgb(240, 248, 255)
        note right of Workflow: Phase 1: Variables Audit
        Workflow->>Context: Dump vars.* (JSON)
        Context-->>Workflow: Show App Host, Ciphertext, MFA URL
    end
    
    rect rgb(255, 240, 240)
        note right of Workflow: Phase 2: Secrets Audit
        Workflow->>Context: Dump secrets.* (JSON)
        Context-->>Workflow: Show Keys (Values masked ***)
        note right of Workflow: Proves Vault Injection worked
    end
    
    rect rgb(240, 255, 240)
        note right of Workflow: Phase 3: PKI Health Check
        Workflow->>Context: Check SSL_CERTIFICATE_PEM
        Context-->>Workflow: Validate PEM Header format
        Workflow->>Workflow: âœ… Pass / âŒ Fail
    end
```

### How to verify the deployment?

1.  Go to the **Actions** tab in this repository.
2.  Click on the latest run of **"ğŸ•µï¸ Verify Vault Sync"**.
3.  Expand the steps to see:
      * **Encryption Result:** The encrypted text from the Transit engine.
      * **MFA Setup:** The URL to configure your Authenticator.
      * **PKI Validation:** Confirmation that SSL certs are valid PEM files.

-----

## ğŸš€ Usage Guide

### 1\. Prerequisites

  * Terraform \>= 1.5
  * Access to the Vault API (Admin Token)
  * GitHub Personal Access Token (PAT) with `repo` scope.

### 2\. Environment Setup

**Security Warning:** Never commit secrets to Git. Use Environment Variables.

```bash
# Vault Connection (Edge/Synology)
export TF_VAR_vault_addr="[http://192.168.](http://192.168.)X.X:8200"
export TF_VAR_vault_token="hvs.your_admin_token"

# GitHub Connection (Cloud)
export GITHUB_TOKEN="ghp_your_github_pat"
```

### 3\. Deployment

```bash
# Download plugins
terraform init

# Preview changes (Dry Run)
terraform plan

# Apply configuration
terraform apply
```

-----

## ğŸ“‚ Project Structure

```text
.
â”œâ”€â”€ provider.tf          # ğŸ”Œ Provider Config (Vault, GitHub)
â”œâ”€â”€ variables.tf         # ğŸ“¥ Inputs definition
â”œâ”€â”€ main.tf              # ğŸ›¡ï¸ Core Governance (Policies, Auth)
â”œâ”€â”€ vault_kv.tf          # ğŸ“¦ App Secrets (KVv2)
â”œâ”€â”€ vault_pki.tf         # ğŸ“œ PKI & SSL Certs
â”œâ”€â”€ vault_transit.tf     # ğŸ” Encryption Services
â”œâ”€â”€ vault_totp.tf        # â±ï¸ MFA & Identity
â””â”€â”€ .github/
    â””â”€â”€ workflows/       # ğŸ¤– Audit Automation
```

-----

## ğŸ“œ License

This project is licensed under the [MIT License](https://www.google.com/search?q=LICENSE).